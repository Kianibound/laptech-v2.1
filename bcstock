<?php // bcbatchinfo.php
include_once 'bcheader.php';

if (!isset($_SESSION['user']))
	die("<br /><br />You need to login to view this page");
$user = $_SESSION['user'];
$op = 0;
$Close = 0;

if (isset($_GET['Show']))
{$stat = ($_GET["Show"]);}


if (isset($_GET["view"]))
{
    $view = ($_GET["view"]);
    $_SESSION['batch'] = $view;
}

$batch = $_SESSION['batch'];
if (isset($_GET['op']))
    {$op = ($_GET["op"]);}

if (isset($_GET['Close']))
    {$Close = ($_GET["Close"]);}


if (isset($_POST['text']))
{
	$text = sanitizeString($mysqli, $_POST['text']);
	$text = preg_replace('/\s\s+/', ' ', $text);
	
	$query = "SELECT * FROM bcprofiles WHERE user='$user'";
	if (mysqli_num_rows(queryMysql($mysqli, $query)))
	{
		queryMysql($mysqli, "UPDATE bcprofiles SET text='$text'
				    where user='$user'");
	}
	else
	{
		$query = "INSERT INTO bcprofiles VALUES('$user', '$text')";
		queryMysql($mysqli, $query);
	}
}
else
{
	$query  = "SELECT * FROM bcprofiles WHERE user='$user'";
	$result = queryMysql($mysqli, $query);
	
	if (mysqli_num_rows($result))
	{
		$row  = mysqli_fetch_row($result);
		$text = stripslashes($row[1]);
	}
	else $text = "";
}

echo "<br />";

$text = stripslashes(preg_replace('/\s\s+/', ' ', $text));

if (isset($_FILES['image']['name']))
{
	$saveto = "$user.jpg";
	move_uploaded_file($_FILES['image']['tmp_name'], $saveto);
	$typeok = TRUE;
	
	switch($_FILES['image']['type'])
	{
		case "image/gif":   $src = imagecreatefromgif($saveto); break;

		case "image/jpeg":  // Both regular and progressive jpegs
		case "image/pjpeg":	$src = imagecreatefromjpeg($saveto); break;

		case "image/png":   $src = imagecreatefrompng($saveto); break;

		default:			$typeok = FALSE; break;
	}
	
	if ($typeok)
	{
		list($w, $h) = getimagesize($saveto);
		$max = 100;
		$tw  = $w;
		$th  = $h;
		
		if ($w > $h && $max < $w)
		{
			$th = $max / $w * $h;
			$tw = $max;
		}
		elseif ($h > $w && $max < $h)
		{
			$tw = $max / $h * $w;
			$th = $max;
		}
		elseif ($max < $w)
		{
			$tw = $th = $max;
		}
		
		$tmp = imagecreatetruecolor($tw, $th);
		imagecopyresampled($tmp, $src, 0, 0, 0, 0, $tw, $th, $w, $h);
		imageconvolution($tmp, array( // Sharpen image
							    array(-1, -1, -1),
							    array(-1, 16, -1),
							    array(-1, -1, -1)
						       ), 8, 0);
		imagejpeg($tmp, $saveto);
		imagedestroy($tmp);
		imagedestroy($src);
	}
}
showProfile($mysqli, $user);

if ($Close == 1)
{
    $now = date('c');
    queryMysql($mysqli, "UPDATE bcbatchinfo SET completed = '$now', status = '2'
                 WHERE batchno = '$batch'");
}
echo "<h3>Batch Selected</h3>";
 $result2 = queryMysql($mysqli, "SELECT * FROM bcbatchinfo WHERE batchno = '$batch' ORDER BY batchno");
    $num2 = mysqli_num_rows($result2);
    echo"    <table border='1'>
         <tr>
         <th>Batch #</th>
         <th>Product Code</th>
         <th>Description</th>
         <th>Start Qty</th>
         <th>Qty Added</th>
         <th>Qty Expected</th>
         <th>Start Date</th>
         <th>End Date</th>
         <th>Status</th>
         </tr>";
    for ($j = 0; $j < $num2; ++$j)
    {
        $row2 = mysqli_fetch_row($result2);
        echo "<tr>
            <td>$row2[0]</td>
            <td>$row2[1]</td>
            <td>$row2[2]</td>
            <td>$row2[3]</td>
            <td>$row2[4]</td>
            <td>$row2[5]</td>
            <td>$row2[6]</td>
            <td>$row2[7]</td>";
            switch ($row2[8])
            {
                case 0:
                    echo "<td>Unstarted</td></tr>";    
                Break;
                case 1:
                    echo "<td>Started</td></tr>";    
                Break;
                case 2:
                    echo "<td>Closed</td></tr>";    
                Break;
            }
            
        $qtyToBuild = $row2[3];
        $qtyadd = $row2[4];
        $status = $row2[8];
    }
    echo" </table><br />";
echo"    <table border='1'>
         <tr>
         <th>Operation #</th>
         <th>description</th>
         <th>info</th>
         <th>Completed</th>
         <th>Scrapped</th>
         <th>Available</th>
         <th>Moved to stock</th>
         <th>Moved from stock</th>
         <th>In progress</th>
         </tr>";
// list any Stock associated with batch

// list any orders associated with the batch

// list operations then add details from operations carried out later.
$totallastop = -1;
$in_progress = "";
$to_stock = "";
$From_Stock ="";
 $result2 = queryMysql($mysqli, "SELECT * FROM bcoperations ORDER BY OpNo");
    $num2 = mysqli_num_rows($result2);
    for ($j = 0; $j < $num2; ++$j)
    {
        $row2 = mysqli_fetch_row($result2);
        echo "<tr><td><a href='bcbatchinfo.php?op=$row2[0]'>$row2[0]</td>";
        echo "<td>$row2[1]</td>";
        echo "<td>$row2[2]</td>";
        //get information about what has been don from bc operations doneand add here.
        $result = queryMysql($mysqli, "SELECT * FROM bcoperationsdone
                WHERE operation = '$row2[0]' AND batchno = '$batch'");
        $num = mysqli_num_rows($result);
        $totalcomplete = 0;
        $totalscrap = 0;
        $in_progress = "no";
        $to_stock = 0;
        $From_Stock = 0;
        for ($i = 0; $i < $num; ++$i)
        {
            $row = mysqli_fetch_row($result);
            if ($row[5] != NULL){
            $totalcomplete = $totalcomplete + $row[5];}
            if ($row[6] != NULL){
            $totalscrap = $totalscrap = $row[6];}
            if ($row[8] == NULL) {
            $in_progress = "yes";}
            if ($row[9] != NULL){
            $to_stock = $to_stock + $row[9] ;}
            if ($row[10] != NULL){
            $From_Stock = $From_Stock + $row[10] ;}
        }
        if ($totallastop == -1){
            $available = $qtyToBuild - ($totalcomplete +$totalscrap +$to_stock - $From_Stock);}
        else{
            $available = $totallastop - ($totalcomplete +$totalscrap +$to_stock - $From_Stock);}
        if ($available < "0") echo "not enough equipment to complete";
        $totallastop = $totalcomplete;
        echo "<td>$totalcomplete</td>";
        echo "<td>$totalscrap</td>";
        echo "<td>$available</td>";
        echo "<td>$to_stock</td>";
        echo "<td>$From_Stock</td>";
        echo "<td> $in_progress </td>";
        echo "</tr>";
        // I want to hide the stuff below unless the link is pressed 
        // and add a button so I can hide it again
        if ($row2[0] == $op)
        {
            $result = queryMysql($mysqli, "SELECT * FROM bcoperationsdone
                        WHERE batchno = '$batch' AND operation = '$row2[0]' ORDER BY starttime");
            $num = mysqli_num_rows($result);
            echo"   <table border='4'>
                    <tr>
                    <th>Staff #</th>
                    <th>Start date/time</th>
                    <th>End date/time</th>
                    <th>Quantity</th>
                    <th># Scrapped</th>
                    <th>To stock</th>
                    <th>From stock</th>
                    </tr>";
            for ($ki = 0; $ki < $num; ++$ki)
            {
                $row = mysqli_fetch_row($result);
            echo"   <tr>
                    <td> ".$row[2]." </td>
                    <td> ".$row[7]."</td>
                    <td> ".$row[8]."</td>
                    <td> ".$row[5]."</td>
                    <td> ".$row[6]."</td>
                    <td> ".$row[9]."</td>
                    <td> ".$row[10]."</td>
                    </tr>";
            }
            if ($row2[0] != $num2)
            {
            echo" </table>";
            echo"   <table border='1'>
             <tr>
             <th>Operation #</th>
             <th>description</th>
             <th>info</th>
             <th>Completed</th>
             <th>Scrapped</th>
             <th>Available</th>
             <th>Moved to stock</th>
             <th>Moved From stock</th>
             <th>In progress</th>
             </tr>";
             }
            echo "<form name='input' action'bcbatchinfo.php' method='get'>
                <input type='submit' value='Hide' />
                </form>";
            
        }
    }
    echo "</table></li><br />";
// send batch number to remove operation and return
// list operations, applicable documents and work carried out
If ($status != 2)
{
echo <<<_END

<table class="Start Operation" border="0" cellpadding="2"
	cellspacing="5" bgcolor="#eeeeee">
<th colspan="2" align="center">Start Operation</th>
<form method="post" action="StartOp.php?View=$batch"
	onSubmit="return validate(this)">
	 <tr><td>Operation Number</td><td><input type="text" maxlength="3"
	name="OpNo" /></td>
</tr><tr><td colspan="2" align="center">
	<input type="submit" value="Go" /></td>
</tr></form></table>

</br>

<table class="End Operation" border="0" cellpadding="2"
	cellspacing="5" bgcolor="#eeeeee">
<th colspan="2" align="center">End Operation</th>
<form method="post" action="DoOp.php?View=$batch"
	onSubmit="return validate(this)">
	 <tr><td>Operation Number</td><td><input type="text" maxlength="3"
	name="OpNo" /></td>
</tr><tr><td>Quantity</td><td><input type="text" maxlength="16"
	name="Quantity" /></td>
</tr><tr><td>Quantity Scrapped</td><td><input type="text" maxlength="16"
	name="Scrapped" /></td>
</tr><tr><td>Moved to stock</td><td><input type="text" maxlength="16"
	name="Stock" /></td>
</tr><tr><td>Moved from stock</td><td><input type="text" maxlength="16"
	name="From_Stock" /></td>
</tr><tr><td colspan="2" align="center">
	<input type="submit" value="Go" /></td>
</tr></form></table>

</br>

<form name="close" action="bcbatchinfo.php?Close=1" method="post">
Close this batch. Note all operations will be locked after this action.
<input type="submit" value="close" />
</form>
_END;
}
else 
{
    echo "<H2>This batch is closed No operations can be carried out<H2><br />";
}
echo <<<_END
</br></br>
<form method='post' action='bcprofile.php'
	enctype='multipart/form-data'>
Enter or edit your details and/or upload an image:<br />
<textarea name='text' cols='40' rows='3'>$text</textarea><br />
Image: <input type='file' name='image' size='14' maxlength='32' />
<input type='submit' value='Save Profile' />
</pre></form>
_END;
?>
